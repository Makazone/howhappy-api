// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SurveyStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum UploadState {
  PREPARED
  UPLOADING
  COMPLETED
  FAILED
}

model User {
  id           String           @id @default(uuid())
  email        String           @unique
  passwordHash String
  displayName  String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  surveys      Survey[]
  responses    SurveyResponse[] @relation("UserResponses")
}

model Survey {
  id             String       @id @default(uuid())
  ownerId        String
  title          String
  prompt         String       @db.Text
  status         SurveyStatus @default(DRAFT)
  visits         Int          @default(0)
  submits        Int          @default(0)
  insightSummary String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  owner     User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  responses SurveyResponse[]

  @@index([ownerId])
  @@index([status])
}

model SurveyResponse {
  id                  String      @id @default(uuid())
  surveyId            String
  registeredUserId    String?
  anonymousEmail      String?
  audioUrl            String?
  uploadState         UploadState @default(PREPARED)
  transcription       String?     @db.Text
  transcriptionStatus JobStatus   @default(PENDING)
  analysis            Json?
  analysisStatus      JobStatus   @default(PENDING)
  duration            Int?
  confidence          Float?
  language            String?
  segments            Json?
  metadata            Json?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  survey    Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  responder User?  @relation("UserResponses", fields: [registeredUserId], references: [id], onDelete: SetNull)

  @@index([surveyId])
  @@index([registeredUserId])
  @@index([uploadState])
  @@index([transcriptionStatus])
  @@index([analysisStatus])
}
